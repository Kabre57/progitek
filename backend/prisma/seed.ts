import { PrismaClient } from '@prisma/client';
import * as bcrypt from 'bcrypt';
import { config } from '../src/config/config';

const prisma = new PrismaClient();

async function main() {
  console.log('üå± D√©but du seeding...');

  // Nettoyer la base de donn√©es
  console.log('üßπ Nettoyage de la base de donn√©es...');
  await prisma.auditLogs.deleteMany();
  await prisma.notification.deleteMany();
  await prisma.notificationPreferences.deleteMany();
  await prisma.report.deleteMany();
  await prisma.factureLigne.deleteMany();
  await prisma.facture.deleteMany();
  await prisma.devisLigne.deleteMany();
  await prisma.devis.deleteMany();
  await prisma.technicienIntervention.deleteMany();
  await prisma.intervention.deleteMany();
  await prisma.mission.deleteMany();
  await prisma.technicien.deleteMany();
  await prisma.specialite.deleteMany();
  await prisma.client.deleteMany();
  await prisma.utilisateur.deleteMany();
  await prisma.role.deleteMany();

  // Cr√©er les r√¥les
  console.log('üëë Cr√©ation des r√¥les...');
  const roles = await Promise.all([
    prisma.role.create({ data: { libelle: 'admin', description: 'Administrateur avec tous les droits' } }),
    prisma.role.create({ data: { libelle: 'user', description: 'Utilisateur standard' } }),
    prisma.role.create({ data: { libelle: 'manager', description: 'Gestionnaire avec droits de supervision' } }),
    prisma.role.create({ data: { libelle: 'technicien', description: 'Technicien avec droits d\'intervention' } }),
  ]);

  // Cr√©er les utilisateurs
  console.log('üë§ Cr√©ation des utilisateurs...');
  const passwords = {
    admin: await bcrypt.hash('Kwt010100++@', config.security.bcryptRounds),
    user: await bcrypt.hash('user123', config.security.bcryptRounds),
    technicien: await bcrypt.hash('technicien123', config.security.bcryptRounds),
  };

  const emails = [
    { nom: 'Admin', prenom: 'System', email: 'admin@progiteck.com', roleId: roles[0].id },
    { nom: 'kabre', prenom: 'theodore', email: 'theogeoffroy5@gmail.com', roleId: roles[1].id },
    { nom: 'kabre', prenom: 'theodore', email: 'technicien@progiteck.com', roleId: roles[3].id }, // Utilisez un email unique
  ];

  const users = [];

  for (const user of emails) {
    const existingUser = await prisma.utilisateur.findUnique({
      where: { email: user.email },
    });

    if (!existingUser) {
      const newUser = await prisma.utilisateur.create({
        data: {
          nom: user.nom,
          prenom: user.prenom,
          email: user.email,
          motDePasse: passwords[user.roleId === roles[0].id ? 'admin' : user.roleId === roles[1].id ? 'user' : 'technicien'],
          phone: '+225 07 00 00 00 00', // Ajustez les num√©ros de t√©l√©phone si n√©cessaire
          roleId: user.roleId,
          status: 'active',
          emailStatus: 'verified',
        },
      });
      users.push(newUser);
    } else {
      console.log(`Utilisateur avec l'email ${user.email} existe d√©j√†, saut de la cr√©ation.`);
      users.push(existingUser);
    }
  }

  const [admin, user, technicien] = users;

  // Continuez avec le reste de votre script...

  // Cr√©er les sp√©cialit√©s
  console.log('üîß Cr√©ation des sp√©cialit√©s...');
  const specialites = await Promise.all([
    prisma.specialite.create({
      data: {
        libelle: 'R√©seau',
        description: 'Sp√©cialiste en infrastructure r√©seau',
      },
    }),
    prisma.specialite.create({
      data: {
        libelle: 'd√©veloppeur web',
        description: 'D√©veloppement d\'applications web',
      },
    }),
    prisma.specialite.create({
      data: {
        libelle: 'Hardware',
        description: 'Maintenance et r√©paration mat√©rielle',
      },
    }),
    prisma.specialite.create({
      data: {
        libelle: 'DevOps',
        description: 'D√©ploiement et infrastructure',
      },
    }),
    prisma.specialite.create({
      data: {
        libelle: 'Software',
        description: 'D√©veloppement logiciel',
      },
    }),
  ]);

  // Cr√©er les techniciens
  console.log('üë®‚Äçüîß Cr√©ation des techniciens...');
  const techniciens = await Promise.all([
    prisma.technicien.create({
      data: {
        nom: 'Konan',
        prenom: 'Yane',
        contact: '+225 06 12 34 56 78',
        specialiteId: specialites[0].id, // R√©seau
      },
    }),
    prisma.technicien.create({
      data: {
        nom: 'Theodore',
        prenom: 'Kabres',
        contact: '+225 07 57 39 01 57',
        specialiteId: specialites[1].id, // d√©veloppeur web
      },
    }),
    prisma.technicien.create({
      data: {
        nom: 'KOUASSI',
        prenom: 'BEIBRO',
        contact: '+225 07 00 22 18 60',
        specialiteId: specialites[2].id, // Hardware
      },
    }),
  ]);

  // Cr√©er les clients
  console.log('üè¢ Cr√©ation des clients...');
  const clients = await Promise.all([
    prisma.client.create({
      data: {
        nom: 'INFAS',
        email: 'contact@infas.ci',
        telephone: '+225 27 22 48 61 22',
        entreprise: 'Institut National de Formation des Agents de Sant√©',
        typeDeCart: 'Premium',
        statut: 'active',
        localisation: 'Abidjan, C√¥te d\'Ivoire',
      },
    }),
    prisma.client.create({
      data: {
        nom: 'DataSys Industries',
        email: 'info@datasys.ci',
        telephone: '+225 27 22 50 30 40',
        entreprise: 'DataSys Industries',
        typeDeCart: 'Standard',
        statut: 'active',
        localisation: 'Abidjan, C√¥te d\'Ivoire',
      },
    }),
    prisma.client.create({
      data: {
        nom: 'InnovateTech',
        email: 'contact@innovatetech.ci',
        telephone: '+225 07 07 07 07 07',
        entreprise: 'InnovateTech Solutions',
        typeDeCart: 'VIP',
        statut: 'active',
        localisation: 'Abidjan, C√¥te d\'Ivoire',
      },
    }),
  ]);

  // Cr√©er les missions
  console.log('üìã Cr√©ation des missions...');
  const missions = await Promise.all([
    prisma.mission.create({
      data: {
        natureIntervention: 'Maintenance r√©seau',
        objectifDuContrat: 'Assurer le bon fonctionnement du r√©seau',
        description: 'Maintenance pr√©ventive du r√©seau informatique',
        dateSortieFicheIntervention: new Date('2024-01-15'),
        clientId: clients[0].id, // INFAS
      },
    }),
    prisma.mission.create({
      data: {
        natureIntervention: 'Installation serveur',
        objectifDuContrat: 'Mise en place d\'un nouveau serveur',
        description: 'Installation et configuration d\'un nouveau serveur',
        dateSortieFicheIntervention: new Date('2024-01-18'),
        clientId: clients[1].id, // DataSys Industries
      },
    }),
    prisma.mission.create({
      data: {
        natureIntervention: 'Audit d√©veloppeur web',
        objectifDuContrat: '√âvaluer l\'infrastructure informatique',
        description: 'Audit complet de la d√©veloppeur web informatique',
        dateSortieFicheIntervention: new Date('2024-01-20'),
        clientId: clients[2].id, // InnovateTech
      },
    }),
  ]);

  // Cr√©er les interventions
  console.log('üõ†Ô∏è Cr√©ation des interventions...');
  const interventions = await Promise.all([
    prisma.intervention.create({
      data: {
        dateHeureDebut: new Date('2024-01-15T10:00:00Z'),
        dateHeureFin: new Date('2024-01-15T13:30:00Z'),
        duree: 210, // 3h30
        missionId: missions[0].numIntervention,
        technicienInterventions: {
          create: {
            technicienId: techniciens[0].id,
            role: 'principal'
          }
        }
      },
    }),
    prisma.intervention.create({
      data: {
        dateHeureDebut: new Date('2024-01-16T15:00:00Z'),
        missionId: missions[1].numIntervention,
        technicienInterventions: {
          create: {
            technicienId: techniciens[1].id,
            role: 'principal'
          }
        }
      },
    }),
    prisma.intervention.create({
      data: {
        dateHeureDebut: new Date('2024-01-18T11:00:00Z'),
        missionId: missions[2].numIntervention,
        technicienInterventions: {
          create: {
            technicienId: techniciens[2].id,
            role: 'principal'
          }
        }
      },
    }),
  ]);

  // Cr√©er un devis
  console.log('üìù Cr√©ation d\'un devis...');
  const devis = await prisma.devis.create({
    data: {
      numero: 'DEV-2024-0001',
      clientId: clients[0].id,
      missionId: missions[0].numIntervention,
      titre: 'Maintenance r√©seau annuelle',
      description: 'Contrat de maintenance r√©seau pour l\'ann√©e 2024',
      montantHT: 1500000,
      tauxTVA: 18,
      montantTTC: 1770000,
      statut: 'brouillon',
      dateCreation: new Date(),
      dateValidite: new Date('2024-02-15'),
      lignes: {
        create: [
          {
            designation: 'Maintenance pr√©ventive trimestrielle',
            quantite: 4,
            prixUnitaire: 250000,
            montantHT: 1000000,
            ordre: 1,
          },
          {
            designation: 'Intervention d\'urgence',
            quantite: 5,
            prixUnitaire: 100000,
            montantHT: 500000,
            ordre: 2,
          },
        ],
      },
    },
  });

  // Cr√©er des notifications
  console.log('üîî Cr√©ation des notifications...');
  await Promise.all([
    prisma.notification.create({
      data: {
        userId: admin.id,
        type: 'info',
        message: 'Bienvenue sur Progitek System',
        createdAt: new Date(),
      },
    }),
    prisma.notification.create({
      data: {
        userId: user.id,
        type: 'info',
        message: 'Bienvenue sur Progitek System',
        createdAt: new Date(),
      },
    }),
    prisma.notification.create({
      data: {
        userId: admin.id,
        type: 'warning',
        message: 'Nouvelle mission assign√©e #1003',
        data: JSON.stringify({ missionId: missions[2].numIntervention }),
        createdAt: new Date(),
      },
    }),
  ]);

  // Cr√©er des pr√©f√©rences de notification
  console.log('‚öôÔ∏è Cr√©ation des pr√©f√©rences de notification...');
  await Promise.all([
    prisma.notificationPreferences.create({
      data: {
        userId: admin.id,
        checkUnusualActivity: true,
        checkNewSignIn: true,
        notifyLatestNews: true,
        notifyFeatureUpdate: true,
        notifyAccountTips: false,
      },
    }),
    prisma.notificationPreferences.create({
      data: {
        userId: user.id,
        checkUnusualActivity: true,
        checkNewSignIn: true,
        notifyLatestNews: false,
        notifyFeatureUpdate: false,
        notifyAccountTips: false,
      },
    }),
  ]);

  // Cr√©er des logs d'audit
  console.log('üìù Cr√©ation des logs d\'audit...');
  await Promise.all([
    prisma.auditLogs.create({
      data: {
        userId: admin.id,
        actionType: 'LOGIN',
        entityType: 'USER',
        details: 'Connexion r√©ussie',
        ipAddress: '192.168.1.100',
        timestamp: new Date(),
      },
    }),
    prisma.auditLogs.create({
      data: {
        userId: admin.id,
        actionType: 'CREATE',
        entityType: 'CLIENT',
        entityId: clients[0].id,
        details: `Client ${clients[0].nom} cr√©√©`,
        ipAddress: '192.168.1.100',
        timestamp: new Date(),
      },
    }),
    prisma.auditLogs.create({
      data: {
        userId: admin.id,
        actionType: 'CREATE',
        entityType: 'MISSION',
        entityId: missions[0].numIntervention,
        details: `Mission ${missions[0].natureIntervention} cr√©√©e`,
        ipAddress: '192.168.1.100',
        timestamp: new Date(),
      },
    }),
  ]);

  console.log('‚úÖ Seeding termin√© avec succ√®s !');
}

main()
  .catch((e) => {
    console.error('‚ùå Erreur lors du seeding:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });